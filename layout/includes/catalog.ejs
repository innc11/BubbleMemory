<% let tocData = generateToc(article.content) %>
<% if (theme.toc && tocData.length>0) { %>
    <div class="card shadow border-0 bg-secondary toc-container">
        <a class="carousel-control-prev" id="toc-nomiao" style="writing-mode: vertical-lr; user-select: none; cursor: pointer; font-weight: bold;">
            <i class="fa fa-chevron-left" aria-hidden="true"></i>
            &nbsp;&nbsp;&nbsp;Table of Contents&nbsp;&nbsp;目&nbsp;录
        </a>
        <div class="card-img container container-lg py-5 toc">
            <strong style="margin-left: 50px;">文章目录</strong>
            <span onclick="tocshow()" style="float: right; font-size: 25px; margin-right: 1px; line-height: 1; cursor: pointer;"><i class="fa fa-times" aria-hidden="true"></i></span>
            <div class="toc-list">
                <%- tocData %>
            </div>
            <style>
                .toc {
                    height: 400px;
                }
                .toc-container {
                    width: 230px;
                    right: -200px;
                }
                .toc-list {
                    overflow-y: auto;
                    overflow-x: hidden;
                }
                .toc-list ol {
                    padding-inline-start: 20px;
                }
                .toc-toc {
                    padding-inline-start: 0px;
                }
                #toc-nomiao {
                    transition: background-color 0.2s;
                }
                #toc-nomiao:hover {
                    background-color: #929292;
                    border-radius: .25rem;
                }
            </style>
        </div>
    </div>
    <script>
        var onshow = false;

        function tocshow() {
            if (onshow) {
                $(".toc-container").css("right", '-200px')
                $(".toc-container .carousel-control-prev i").removeClass("fa-chevron-right").addClass("fa-chevron-left")
            } else {
                $(".toc-container").css("right", '20px')
                $(".toc-container .carousel-control-prev i").removeClass("fa-chevron-left").addClass("fa-chevron-right")
            }
            onshow = !onshow
        }

        function jumpto(name) {
            $('html,body').animate({
                scrollTop: $('[id="' + name + '"]').offset().top - 120
            }, 500)
        }
        $("#toc-nomiao").click(tocshow)
        var nowtoc = "tocname-"
        $(document).ready(function() {
            <% if (theme.toc_open) { %>
                tocshow()
            <% } %>

            $(document).scroll(function() {
                for (var ele of $(".content").find("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]").get().reverse()) 
                {
                    if ($(document).scrollTop() + 121 > $(ele).offset().top) 
                    {
                        if (nowtoc != ele.name) 
                        {
                            let tocele = $("*[name='tocname-" + encodeURI(nowtoc) + "']")
                            tocele.removeClass("located")

                            tocele = $("*[name='tocname-" + encodeURI(ele.id) + "']")
                            tocele.addClass("located")

                            let tocList = $(".toc-list")
                            if(tocList.length > 0) {
                                tocList.stop(true) // 停止掉未执行完毕的动画
                                tocList.animate({
                                    scrollTop: tocList.scrollTop() - 50 + tocele.position().top
                                }, 40)
                                nowtoc = ele.id
                            }
                        }
                        break
                    }
                }
                
            })
        });
    </script>
<% } %>